<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Underground TV PT - Flash Mode</title>
    <!-- Favicon -->
    <link rel="icon" href="https://framagit.org/fiat-tux/hat-softwares/lufi/-/raw/master/themes/default/public/img/lufi.png">
    
    <!-- Bibliotecas Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Adicionado LocalForage para Cache Robusta (IndexedDB) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        accent: '#3b82f6', 
                        'op-yellow': '#FFD700', 
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .glass-effect { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); }
        .file-drop-zone { border: 2px dashed #475569; transition: all 0.3s ease; }
        .file-drop-zone:hover, .file-drop-zone.dragover { border-color: #FFD700; background-color: rgba(255, 215, 0, 0.1); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-animate { animation: fadeIn 0.3s ease-out forwards; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        
        .modal-open #mainDashboard { filter: blur(4px); pointer-events: none; }
        
        /* Loading Ring custom animation */
        .lds-ring { display: inline-block; position: relative; width: 14px; height: 14px; }
        .lds-ring div { box-sizing: border-box; display: block; position: absolute; width: 12px; height: 12px; margin: 1px; border: 2px solid #FFD700; border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: #FFD700 transparent transparent transparent; }
        .lds-ring div:nth-child(1) { animation-delay: -0.45s; }
        .lds-ring div:nth-child(2) { animation-delay: -0.3s; }
        .lds-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes lds-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- TELA DE UPLOAD -->
    <div id="uploadSection" class="fixed inset-0 z-50 flex items-center justify-center bg-dark overflow-hidden">
        
        <!-- IMAGEM DE FUNDO -->
        <div class="absolute inset-0 z-0 select-none pointer-events-none">
            <img src="https://4kwallpapers.com/images/wallpapers/gear-5-monkey-d-6001x3841-17522.jpg" 
                 class="w-full h-full object-cover opacity-15 blur-[6px] grayscale-[30%] scale-110 transform" 
                 alt="Background">
            <div class="absolute inset-0 bg-gradient-to-t from-dark via-dark/90 to-transparent"></div>
        </div>

        <div class="max-w-xl w-full text-center space-y-6 relative z-10 p-4">
            <div class="mb-4">
                <img src="https://framagit.org/fiat-tux/hat-softwares/lufi/-/raw/master/themes/default/public/img/lufi.png" 
                     class="w-32 h-32 mx-auto mb-4 animate-float drop-shadow-[0_0_15px_rgba(255,215,0,0.3)] object-contain" 
                     alt="Logo">
                <h1 class="text-4xl font-extrabold tracking-tight text-white drop-shadow-lg">
                    Underground <span class="text-op-yellow">TV PT</span>
                </h1>
                <p class="text-gray-300 mt-2 font-medium drop-shadow-md">Dashboard de Gestão de Contas</p>
                <!-- Indicador de Carregamento de Cache -->
                <p id="cacheLoadingMsg" class="hidden text-op-yellow text-xs font-bold animate-pulse mt-2">
                    <i class="fa-solid fa-database"></i> A verificar dados guardados...
                </p>
            </div>

            <div class="file-drop-zone bg-card/60 backdrop-blur-md p-8 rounded-2xl cursor-pointer relative group border-gray-600 hover:border-op-yellow shadow-2xl transition-all" id="dropZone">
                <input type="file" id="fileInput" accept=".json, .csv, .xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="space-y-3 pointer-events-none">
                    <div class="w-14 h-14 bg-gray-700/50 rounded-full flex items-center justify-center mx-auto group-hover:bg-op-yellow group-hover:text-dark transition-colors border border-gray-600">
                        <i class="fa-solid fa-bolt text-2xl text-white group-hover:text-dark"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Carregar Base de Dados</h3>
                        <p class="text-xs text-gray-300 mt-1">
                            Suporta: <span class="text-op-yellow font-bold">JSON (Recomendado)</span>, CSV, Excel
                        </p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4 text-gray-400 text-sm">
                <div class="h-px bg-gray-600 flex-grow"></div>
                <span>OU</span>
                <div class="h-px bg-gray-600 flex-grow"></div>
            </div>

            <div class="bg-card/60 backdrop-blur-md p-4 rounded-2xl border border-gray-600 shadow-xl">
                <label class="block text-left text-xs text-gray-300 mb-2 font-bold ml-1">
                    <i class="fa-brands fa-google-drive text-green-400 mr-1"></i> Importar do Google Drive / URL
                </label>
                <div class="flex gap-2">
                    <input type="text" id="gSheetInput" placeholder="Cola o link do Drive, Gist ou URL direta..." 
                        class="flex-grow bg-dark/80 border border-gray-600 text-white text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-op-yellow transition-colors">
                    <button onclick="loadFromUrl()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all shadow-lg hover:shadow-green-500/20">
                        <i class="fa-solid fa-cloud-arrow-down"></i>
                    </button>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-left ml-1">Suporta Google Drive, Sheets e Links Diretos (Raw).</p>
            </div>
            
            <!-- SECÇÃO DE RETOMA DE SESSÃO (NOVO) -->
            <div id="resumeSection" class="hidden animate-float">
                <div class="flex items-center gap-4 text-gray-400 text-sm mb-4">
                    <div class="h-px bg-gray-600 flex-grow"></div>
                    <span class="text-op-yellow font-bold text-xs uppercase tracking-widest">Sessão Guardada</span>
                    <div class="h-px bg-gray-600 flex-grow"></div>
                </div>

                <button onclick="resumeDashboard()" class="w-full bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 border border-op-yellow/30 hover:border-op-yellow text-white p-4 rounded-xl shadow-lg transition-all group relative overflow-hidden">
                    <div class="absolute inset-0 bg-op-yellow/5 group-hover:bg-op-yellow/10 transition-colors"></div>
                    <div class="relative flex items-center justify-between">
                        <div class="text-left">
                            <h3 class="font-bold text-base flex items-center gap-2">
                                <i class="fa-solid fa-rotate-right text-op-yellow"></i> Continuar Sessão
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">
                                Última atualização: <span id="lastUpdateDate" class="text-gray-300 font-mono">--/--/----</span>
                            </p>
                        </div>
                        <div class="bg-dark/50 p-2 rounded-lg border border-gray-700 group-hover:border-op-yellow/50 transition-colors">
                            <i class="fa-solid fa-chevron-right text-gray-400 group-hover:text-white"></i>
                        </div>
                    </div>
                </button>
            </div>

            <button id="btnBackToDash" onclick="returnToDashboard()" class="hidden px-6 py-2 bg-gray-700/80 hover:bg-gray-600 text-white rounded-full transition-colors flex items-center gap-2 mx-auto backdrop-blur-sm">
                <i class="fa-solid fa-arrow-left"></i> Voltar ao Dashboard
            </button>
            
            <div id="loadingIndicator" class="hidden">
                <i class="fa-solid fa-circle-notch fa-spin text-op-yellow text-3xl"></i>
                <p class="mt-2 text-sm text-gray-300 font-bold">A processar e guardar dados...</p>
                <p id="loadingTextDetail" class="text-[10px] text-gray-500">Isto não irá bloquear o browser</p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="mainDashboard" class="hidden min-h-screen flex flex-col w-full relative z-20 bg-dark">
        <!-- HEADER -->
        <header class="sticky top-0 z-40 glass-effect border-b border-gray-700 shadow-lg">
            <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full md:w-auto justify-between">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.reload()">
                        <img src="https://framagit.org/fiat-tux/hat-softwares/lufi/-/raw/master/themes/default/public/img/lufi.png" class="w-8 h-8 object-contain">
                        <h1 class="text-xl font-bold tracking-wider">Underground <span class="text-op-yellow">TV PT</span></h1>
                    </div>
                </div>

                <!-- BARRA DE PESQUISA -->
                <div class="relative w-full max-w-md">
                    <input type="text" id="searchInput" placeholder="Pesquisar em 40k+ contas..." 
                        class="w-full bg-gray-800 text-white rounded-full py-2 px-5 pl-10 focus:outline-none focus:ring-2 focus:ring-op-yellow border border-gray-700 shadow-inner">
                    <i class="fa-solid fa-search absolute left-3.5 top-3 text-gray-400"></i>
                </div>

                <div class="flex items-center gap-3">
                    
                    <!-- CONTADOR TOTAL (RESTAURADO) -->
                    <div class="text-sm font-semibold bg-op-yellow/10 text-op-yellow px-4 py-1.5 rounded-full border border-op-yellow/20 hidden xl:block">
                        <span id="totalCount">0</span> Contas
                    </div>

                    <!-- BOTÃO ATUALIZAR LISTA -->
                    <button onclick="triggerUpdateUpload()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold transition-all shadow-lg flex items-center gap-2 border border-blue-400/30" title="Carregar novo ficheiro e substituir o atual">
                        <i class="fa-solid fa-cloud-arrow-up"></i> <span class="hidden sm:inline">Atualizar Lista</span>
                    </button>

                    <!-- BOTÃO GUIA DE APPS -->
                    <button onclick="openTutorialModal()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-1.5 rounded-full text-xs font-bold transition-all shadow-lg flex items-center gap-2 hidden md:flex">
                        <i class="fa-solid fa-circle-info"></i> Guia
                    </button>
                    
                    <!-- BOTÃO SAIR / LIMPAR CACHE -->
                    <button onclick="clearCacheAndLogout()" class="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-4 py-1.5 rounded-full text-xs font-bold transition-all border border-red-500/30 flex items-center gap-2" title="Limpar dados guardados">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN LAYOUT (SIDEBAR + GRID) -->
        <main class="container mx-auto px-4 py-8 flex-grow flex flex-col lg:flex-row gap-6">
            
            <!-- SIDEBAR DE FILTROS (Portais) -->
            <aside id="portalSidebarContainer" class="hidden lg:block w-full lg:w-64 flex-shrink-0 transition-all duration-300">
                <div class="bg-card/50 border border-gray-700/50 rounded-xl p-4 sticky top-24 max-h-[calc(100vh-8rem)] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-op-yellow uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-server"></i> Portais
                        </h3>
                        <span id="portalCountBadge" class="bg-gray-800 text-gray-400 text-[10px] px-2 py-0.5 rounded-full">0</span>
                    </div>
                    
                    <div class="mb-3 relative">
                        <input type="text" id="portalSearch" placeholder="Filtrar lista..." class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-1.5 text-xs text-white focus:outline-none focus:border-op-yellow/50">
                    </div>

                    <div id="portalList" class="space-y-1 overflow-y-auto custom-scrollbar flex-grow pr-1">
                        <!-- Lista injetada via JS -->
                        <div class="text-center py-4 text-gray-500 text-xs">Carregando...</div>
                    </div>
                    
                    <button onclick="clearPortalFilter()" id="btnClearPortal" class="hidden mt-3 w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 text-xs font-bold py-2 rounded-lg transition-all">
                        Limpar Filtro
                    </button>
                </div>
            </aside>

            <!-- CONTEÚDO PRINCIPAL (Grelha) -->
            <div class="flex-grow min-w-0">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
                    <div class="flex gap-2 overflow-x-auto pb-2 scroll-hide w-full sm:w-auto" id="typeFilters">
                        <button class="whitespace-nowrap px-4 py-1.5 rounded-full bg-op-yellow text-dark text-sm font-bold shadow-lg shadow-op-yellow/20" onclick="filterType('all', this)">Todos</button>
                        <button class="whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-800 text-gray-400 hover:text-white text-sm font-medium border border-gray-700" onclick="filterType('xtream', this)">Xtream</button>
                        <button class="whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-800 text-gray-400 hover:text-white text-sm font-medium border border-gray-700" onclick="filterType('mac', this)">Stalker / MAC</button>
                    </div>
                    
                    <!-- INFO DE STATUS DE DADOS E SYNC -->
                    <div class="flex items-center gap-3">
                        <div class="text-xs flex items-center gap-2" id="dataStatusMsg">
                            <!-- Injetado via JS -->
                        </div>
                        <select id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)" class="bg-gray-800 text-gray-300 text-xs rounded-lg px-3 py-2 border border-gray-700 focus:outline-none">
                            <option value="12">12 por página</option>
                            <option value="24" selected>24 por página</option>
                            <option value="48">48 por página</option>
                            <option value="96">96 por página</option>
                            <option value="10000">Listar Todas (Cuidado)</option>
                        </select>
                    </div>
                </div>

                <!-- OVERLAY DE CARREGAMENTO NO DASHBOARD -->
                <div id="dashLoadingOverlay" class="hidden absolute inset-0 z-50 bg-dark/80 backdrop-blur-sm flex flex-col items-center justify-center rounded-xl">
                     <i class="fa-solid fa-rotate fa-spin text-op-yellow text-4xl mb-3"></i>
                     <h3 class="text-white font-bold text-lg">A atualizar base de dados...</h3>
                     <p class="text-gray-400 text-sm">A processar o novo ficheiro.</p>
                </div>

                <div id="gridContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-6 relative"></div>
                
                <div id="noResults" class="hidden text-center py-20">
                    <i class="fa-solid fa-skull-crossbones text-6xl text-gray-700 mb-4 animate-pulse"></i>
                    <p class="text-gray-500 text-lg">Nenhum tesouro encontrado.</p>
                </div>

                <div id="paginationContainer" class="hidden mt-8 flex flex-col sm:flex-row justify-between items-center border-t border-gray-800 pt-6 gap-4">
                    <span class="text-sm text-gray-400">
                        A mostrar <span id="pageStart" class="text-white font-bold">0</span> até <span id="pageEnd" class="text-white font-bold">0</span> de <span id="pageTotal" class="text-white font-bold">0</span> resultados
                    </span>
                    <div class="flex items-center gap-2">
                        <button onclick="changePage(-1)" id="btnPrev" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg disabled:opacity-50 transition-colors">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <div class="px-4 py-2 bg-gray-800/50 rounded-lg text-sm text-gray-300">
                            Página <span id="pageCurrent" class="text-white font-bold">1</span> de <span id="pageMax" class="font-bold">1</span>
                        </div>
                        <button onclick="changePage(1)" id="btnNext" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg disabled:opacity-50 transition-colors">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="border-t border-gray-800 py-6 text-center text-gray-600 text-xs mt-auto">
            <p>Leitor de JSON/CSV/Excel • Dashboard v14.0 (Robust) • Desenvolvido para Underground TV PT</p>
        </footer>
    </div>

    <!-- MODAL DE DETALHES -->
    <div id="detailsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4 transition-all duration-300 opacity-0">
        <div class="bg-card w-full max-w-lg rounded-2xl shadow-2xl border border-gray-700 transform transition-all scale-95 duration-300 overflow-hidden flex flex-col max-h-[90vh]" id="modalContent">
            
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-6 border-b border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-white flex items-center gap-2 truncate pr-4">
                    <i class="fa-solid fa-server text-op-yellow"></i> 
                    <span id="modalTitle" class="truncate">Detalhes</span>
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white hover:bg-white/10 rounded-full p-1 w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar">
                
                <div id="vpnWarningBox" class="hidden animate-pulse">
                    <div class="bg-red-500/10 border border-red-500/50 rounded-lg p-3 flex items-start gap-3">
                        <i class="fa-solid fa-shield-halved text-red-500 text-xl mt-0.5"></i>
                        <div>
                            <h4 class="text-red-500 font-bold text-sm uppercase tracking-wider">Geolock Detectado</h4>
                            <p class="text-xs text-gray-300 mt-1">Este servidor requer o uso de uma <span class="text-white font-bold">VPN</span>.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="group">
                        <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider ml-1 mb-1 block">Host URL</label>
                        <div class="relative">
                            <input type="text" id="modalHost" readonly class="w-full bg-dark border border-gray-700 rounded-lg pl-3 pr-10 py-2.5 text-sm text-gray-300 focus:outline-none font-mono">
                            <button onclick="copyToClipboard('modalHost')" class="absolute right-1 top-1 bottom-1 w-8 flex items-center justify-center text-gray-400 hover:text-white rounded hover:bg-gray-700">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider ml-1 mb-1 block">Username</label>
                            <div class="relative">
                                <input type="text" id="modalUser" readonly class="w-full bg-dark border border-gray-700 rounded-lg pl-3 pr-10 py-2.5 text-sm text-gray-300 focus:outline-none font-mono">
                                <button onclick="copyToClipboard('modalUser')" class="absolute right-1 top-1 bottom-1 w-8 flex items-center justify-center text-gray-400 hover:text-white rounded hover:bg-gray-700">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider ml-1 mb-1 block">Password</label>
                            <div class="relative">
                                <input type="text" id="modalPass" readonly class="w-full bg-dark border border-gray-700 rounded-lg pl-3 pr-10 py-2.5 text-sm text-gray-300 focus:outline-none font-mono">
                                <button onclick="copyToClipboard('modalPass')" class="absolute right-1 top-1 bottom-1 w-8 flex items-center justify-center text-gray-400 hover:text-white rounded hover:bg-gray-700">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="macSection" class="hidden">
                        <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider ml-1 mb-1 block">Endereço MAC</label>
                        <div class="relative">
                            <input type="text" id="modalMac" readonly class="w-full bg-dark border border-op-yellow/30 rounded-lg pl-3 pr-10 py-2.5 text-sm text-op-yellow focus:outline-none font-mono shadow-[0_0_15px_rgba(255,215,0,0.1)]">
                            <button onclick="copyToClipboard('modalMac')" class="absolute right-1 top-1 bottom-1 w-8 flex items-center justify-center text-op-yellow/70 hover:text-op-yellow rounded hover:bg-op-yellow/10 transition-all">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div id="groupsSection" class="pt-2">
                        <label class="text-[10px] text-op-yellow uppercase font-bold tracking-wider ml-1 mb-2 block flex items-center gap-1">
                            <i class="fa-solid fa-layer-group"></i> Grupos de Canais (Live)
                        </label>
                        <div id="modalGroupsContainer" class="bg-dark/50 border border-gray-700/50 rounded-xl p-3 min-h-[60px] max-h-[120px] overflow-y-auto custom-scrollbar flex flex-wrap gap-1.5">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider ml-1 mb-1 block">Validade</label>
                            <div class="flex items-center gap-2 bg-dark border border-gray-700 rounded-lg px-3 py-2.5 h-[42px]">
                                <i class="fa-regular fa-calendar text-gray-500"></i>
                                <span id="modalExp" class="text-sm text-gray-300 truncate"></span>
                            </div>
                        </div>
                        
                        <div id="liveCheckSection">
                            <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider ml-1 mb-1 block">Conexões Ativas</label>
                            <div class="relative">
                                <button id="btnCheckLive" onclick="checkLiveConnectionsInModal()" class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2.5 text-xs font-bold transition-all flex items-center justify-center gap-2 h-[42px]">
                                    <i class="fa-solid fa-rotate"></i> Verificar Agora
                                </button>
                                <div id="liveResult" class="hidden w-full bg-dark border border-op-yellow/50 text-op-yellow rounded-lg px-3 py-2.5 text-xs font-bold flex items-center justify-center gap-2 h-[42px] animate-pulse">
                                    <i class="fa-solid fa-users"></i> <span id="liveResultText">...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="m3uSection" class="pt-4 border-t border-gray-700/50 mt-2">
                         <label class="text-[10px] text-blue-400 uppercase font-bold tracking-wider ml-1 mb-1 block">Playlist Link (M3U Plus)</label>
                         <div class="relative mb-3">
                            <input type="text" id="modalM3u" readonly class="w-full bg-blue-900/10 border border-blue-500/30 rounded-lg pl-3 pr-10 py-2.5 text-xs text-blue-300 focus:outline-none font-mono">
                            <button onclick="copyToClipboard('modalM3u')" class="absolute right-1 top-1 bottom-1 w-8 flex items-center justify-center text-blue-400 hover:text-white rounded hover:bg-blue-500/20">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="downloadPlaylistFromModal()" class="bg-accent hover:bg-blue-600 text-white py-2 rounded-lg shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 text-sm font-medium">
                                <i class="fa-solid fa-download"></i> Download M3U
                            </button>
                            <button onclick="openPlaylistLink()" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-medium">
                                <i class="fa-solid fa-external-link-alt"></i> Abrir Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL GUIA DE APPS -->
    <div id="tutorialModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4 transition-all duration-300 opacity-0">
        <div class="bg-card w-full max-w-2xl rounded-2xl shadow-2xl border border-gray-700 transform transition-all scale-95 duration-300 overflow-hidden flex flex-col max-h-[85vh]" id="tutorialContent">
            
            <div class="bg-gradient-to-r from-op-yellow/20 to-gray-900 p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-3">
                    <i class="fa-solid fa-layer-group text-op-yellow"></i> 
                    Apps Recomendadas
                </h3>
                <button onclick="closeTutorialModal()" class="text-gray-400 hover:text-white hover:bg-white/10 rounded-full p-1 w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="p-6 space-y-8 overflow-y-auto custom-scrollbar">
                
                <!-- Secção XTREAM -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-blue-400 font-bold border-b border-blue-500/20 pb-2">
                        <i class="fa-solid fa-user-circle"></i> Contas XTREAM
                    </div>
                    <p class="text-sm text-gray-300">Estas contas usam <span class="text-white font-bold">Host</span>, <span class="text-white font-bold">User</span> e <span class="text-white font-bold">Pass</span>.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-dark/40 p-4 rounded-xl border border-gray-700">
                            <h4 class="text-xs font-bold text-op-yellow mb-2">Windows / PC</h4>
                            <ul class="text-[11px] space-y-2 text-gray-400">
                                <li><span class="text-white">SFVIP Player:</span> O mais leve e rápido. Basta colar o Host e as credenciais.</li>
                                <li>
                                    <span class="text-white font-bold">IPTVnator:</span> Interface moderna e multiplataforma.
                                    <a href="https://github.com/4gray/iptvnator" target="_blank" class="block text-accent hover:underline mt-1"><i class="fa-brands fa-github"></i> Ver no GitHub</a>
                                </li>
                                <li>
                                    <span class="text-white font-bold">Open TV:</span> Player open-source com suporte Xtream.
                                    <a href="https://github.com/Fredolx/open-tv" target="_blank" class="block text-accent hover:underline mt-1"><i class="fa-brands fa-github"></i> Ver no GitHub</a>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-dark/40 p-4 rounded-xl border border-gray-700">
                            <h4 class="text-xs font-bold text-op-yellow mb-2">Android / Smart TV</h4>
                            <ul class="text-[11px] space-y-2 text-gray-400">
                                <li><span class="text-white">OTT Navigator:</span> Altamente customizável. Perfeito para Xtream.</li>
                                <li><span class="text-white">TiviMate:</span> A melhor interface estilo "Box de Operadora".</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Secção STALKER -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-op-yellow font-bold border-b border-op-yellow/20 pb-2">
                        <i class="fa-solid fa-microchip"></i> Contas STALKER / MAC
                    </div>
                    <p class="text-sm text-gray-300">Estas contas usam apenas <span class="text-white font-bold">Portal URL</span> e um <span class="text-white font-bold">Endereço MAC</span>.</p>
                    <div class="bg-dark/40 p-4 rounded-xl border border-gray-700">
                        <h4 class="text-xs font-bold text-op-yellow mb-2">Como Configurar</h4>
                        <p class="text-[11px] text-gray-400 leading-relaxed">
                            No seu Player (SFVIP ou OTT Navigator), escolha a opção <span class="text-white">"Stalker Portal"</span> ou <span class="text-white">"MAG Device"</span>. 
                            Introduza o Host no campo Portal e configure o MAC ID exatamente como aparece no dashboard. Não é necessário utilizador ou password.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-900/50 border-t border-gray-800 text-center">
                <button onclick="closeTutorialModal()" class="text-xs font-bold text-gray-400 hover:text-white transition-colors">Fechar Guia</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 transform translate-y-32 transition-all duration-300 bg-gray-800 border-l-4 border-green-500 text-white px-6 py-4 rounded shadow-2xl flex items-center gap-4">
        <div class="bg-green-500/20 p-2 rounded-full text-green-400">
            <i class="fa-solid fa-check"></i>
        </div>
        <div>
            <h4 id="toastTitle" class="font-bold text-sm">Sucesso!</h4>
            <p id="toastMessage" class="text-xs text-gray-400"></p>
        </div>
    </div>

    <script>
        // --- 1. FUNÇÕES UTILITÁRIAS (No topo para evitar erros de referência) ---
        function formatDate(d) {
            if (!d) return '';
            try { 
                const dateObj = (d instanceof Date) ? d : new Date(d);
                if (isNaN(dateObj.getTime())) return d.toString(); 
                return dateObj.toLocaleDateString('pt-PT');
            } catch(e) { return d; }
        }

        function getHostName(url) {
            try {
                if (!url) return 'Desconhecido';
                let clean = url.replace(/^https?:\/\//, '');
                if (clean.endsWith('/')) clean = clean.slice(0, -1);
                if (url.startsWith('http')) return new URL(url).hostname;
                return clean.split('/')[0];
            } catch { return url || 'Erro'; }
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            if(el) {
                el.select(); 
                navigator.clipboard.writeText(el.value);
                showToast("Copiado!", false);
            }
        }

        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            if(!t) return;
            document.getElementById('toastMessage').innerText = msg;
            if (isError) {
                t.className = "fixed bottom-6 right-6 z-50 transform transition-all duration-300 bg-gray-800 border-l-4 border-red-500 text-white px-6 py-4 rounded shadow-2xl flex items-center gap-4";
            } else {
                t.className = "fixed bottom-6 right-6 z-50 transform transition-all duration-300 bg-gray-800 border-l-4 border-green-500 text-white px-6 py-4 rounded shadow-2xl flex items-center gap-4";
            }
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        }

        // --- 2. VARIÁVEIS GLOBAIS ---
        let allAccounts = [];
        let filteredAccounts = [];
        let currentFilter = 'all';
        let currentPortalFilter = null;
        let currentAccountIndex = -1;
        let currentPage = 1;
        let itemsPerPage = 24;
        const DEFAULT_FILENAME = 'Resultados_Finais.xlsx';
        const DB_KEY = 'ugtv_db'; // Chave para os dados
        const DB_SOURCE_URL = 'ugtv_source_url'; // Chave para o link de origem
        const DB_TIMESTAMP_KEY = 'ugtv_last_update'; // Chave para o timestamp

        // --- 3. WORKER SCRIPT ---
        const workerScript = `
            importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
            function parseCSV(text) {
                const lines = text.split(/\\r\\n|\\n/);
                const results = [];
                if (lines.length < 2) return [];
                const headerLine = lines[0];
                const delimiter = headerLine.includes(',') ? ',' : ';';
                const headers = headerLine.split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const values = line.split(delimiter);
                    const obj = {};
                    headers.forEach((h, index) => {
                        let val = values[index] ? values[index].trim() : '';
                        val = val.replace(/^"|"$/g, '');
                        obj[h] = val;
                    });
                    if (obj.Host || obj.Username || obj.MAC) results.push(obj);
                }
                return results;
            }
            self.onmessage = function(e) {
                const { data, type } = e.data;
                try {
                    let results = [];
                    if (type === 'json') {
                        const decoder = new TextDecoder("utf-8");
                        const text = decoder.decode(data);
                        results = JSON.parse(text);
                    } else if (type === 'csv') {
                        const decoder = new TextDecoder("utf-8");
                        const text = decoder.decode(data);
                        results = parseCSV(text);
                    } else {
                        const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                        workbook.SheetNames.forEach(sheet => {
                            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);
                            results = results.concat(jsonData);
                        });
                    }
                    const optimizedResults = results.map(acc => {
                        if (!acc.Host && !acc.Username && !acc.MAC) return null;
                        if (acc._search) return acc;
                        const searchStr = ((acc.Host || '') + ' ' + (acc.Username || '') + ' ' + (acc.MAC || '') + ' ' + (acc['Grupos Live'] || '')).toLowerCase();
                        const rawType = (acc.Tipo || '').toLowerCase();
                        const isMac = rawType.includes('mac') || rawType.includes('stalker');
                        return { ...acc, _search: searchStr, _isMac: isMac };
                    }).filter(item => item !== null);
                    optimizedResults.sort((a, b) => {
                        const getTs = (v) => v ? new Date(v).getTime() : 0;
                        return getTs(b.Validade) - getTs(a.Validade);
                    });
                    postMessage({ success: true, data: optimizedResults });
                } catch (err) { postMessage({ success: false, error: err.message }); }
            };
        `;

        const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(workerBlob));

        // --- 4. EVENT LISTENERS & LÓGICA ---
        worker.onmessage = function(e) {
            const response = e.data;
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('dashLoadingOverlay').classList.add('hidden'); // Esconder overlay do dashboard

            if (response.success) {
                allAccounts = response.data;
                filteredAccounts = [...allAccounts];
                
                // SALVAR NO INDEXEDDB (Cache) E TIMESTAMP
                const now = new Date();
                localforage.setItem(DB_KEY, allAccounts)
                    .then(() => localforage.setItem(DB_TIMESTAMP_KEY, now))
                    .then(() => {
                         // Se não estamos no modo Background Update, mostrar aviso
                         if (!window.isBackgroundUpdate) {
                            showToast(`Base de dados atualizada!`, false);
                         } else {
                            showToast(`Lista sincronizada com a nuvem!`, false);
                            updateStatusMsg(true);
                         }
                         window.isBackgroundUpdate = false;
                         
                         // Se for ficheiro local (não URL), definimos msg manual
                         if (!window.isUrlSource) {
                             document.getElementById('dataStatusMsg').innerHTML = `<i class="fa-solid fa-file-import text-gray-400"></i> Ficheiro Local (${allAccounts.length})`;
                         }
                    })
                    .catch((err) => console.error("Erro ao salvar cache:", err));

                showDashboard();
                if(!window.isBackgroundUpdate) {
                    showToast(`Sucesso! ${allAccounts.length} contas carregadas.`, false);
                }
            } else {
                showToast("Erro: " + response.error, true);
            }
        };

        // --- CONFIGURAÇÃO DO LOCALFORAGE ---
        localforage.config({
            name: 'UndergroundTV_DB',
            storeName: 'accounts_store'
        });

        // --- INICIALIZAÇÃO COM VERIFICAÇÃO DE CACHE E BOTÃO DE RETOMA ---
        window.onload = async () => {
            // 1. Tentar carregar do Cache (IndexedDB)
            try {
                document.getElementById('cacheLoadingMsg').classList.remove('hidden');
                
                // Carregar Dados
                const cachedData = await localforage.getItem(DB_KEY);
                // Carregar URL de Origem (se existir)
                const cachedUrl = await localforage.getItem(DB_SOURCE_URL);
                // Carregar Timestamp
                const cachedTime = await localforage.getItem(DB_TIMESTAMP_KEY);

                if (cachedData && Array.isArray(cachedData) && cachedData.length > 0) {
                    console.log("Cache encontrado:", cachedData.length, "items");
                    allAccounts = cachedData;
                    filteredAccounts = [...allAccounts];
                    
                    // LÓGICA DE BOTÃO DE SESSÃO
                    const resumeSection = document.getElementById('resumeSection');
                    const lastUpdateEl = document.getElementById('lastUpdateDate');
                    
                    if (cachedTime) {
                        const d = new Date(cachedTime);
                        lastUpdateEl.innerText = `${d.toLocaleDateString('pt-PT')} ${d.toLocaleTimeString('pt-PT').slice(0,5)}`;
                    } else {
                        lastUpdateEl.innerText = "Desconhecido";
                    }

                    resumeSection.classList.remove('hidden');
                    
                    if (cachedUrl) {
                        // Preencher input invisivelmente para uso futuro
                        document.getElementById('gSheetInput').value = cachedUrl; 
                        document.getElementById('dataStatusMsg').innerHTML = `<i class="fa-solid fa-cloud text-blue-400"></i> Sincronizado (${allAccounts.length})`;
                    } else {
                        document.getElementById('dataStatusMsg').innerHTML = `<i class="fa-solid fa-database text-gray-400"></i> Dados em Cache (${allAccounts.length})`;
                    }
                    
                    // NÃO Entra automaticamente no Dashboard
                    // showDashboard();
                    
                    showToast(`Backup encontrado: ${allAccounts.length} contas.`, false);
                    document.getElementById('cacheLoadingMsg').classList.add('hidden');
                    return; 
                }
            } catch (e) {
                console.error("Erro ao ler cache", e);
            } finally {
                document.getElementById('cacheLoadingMsg').classList.add('hidden');
            }

            // 2. Se não houver cache
            try {
                const response = await fetch(DEFAULT_FILENAME, { method: 'HEAD' });
                if (response.ok) {
                    const blobResp = await fetch(DEFAULT_FILENAME);
                    const blob = await blobResp.blob();
                    processFile(blob); 
                }
            } catch (e) {}
        };

        function resumeDashboard() {
            showDashboard();
            showToast("Sessão restaurada com sucesso!", false);
        }

        function updateStatusMsg(isCloud) {
            if(isCloud) {
                document.getElementById('dataStatusMsg').innerHTML = `<i class="fa-solid fa-cloud text-blue-400"></i> Sincronizado (${allAccounts.length})`;
            } else {
                document.getElementById('dataStatusMsg').innerHTML = `<i class="fa-solid fa-database text-gray-400"></i> Dados Locais (${allAccounts.length})`;
            }
        }

        // --- FUNÇÃO PARA LIMPAR CACHE ---
        async function clearCacheAndLogout() {
            if(confirm("Tem a certeza que deseja limpar os dados guardados e sair?")) {
                try {
                    await localforage.removeItem(DB_KEY);
                    await localforage.removeItem(DB_SOURCE_URL); // Limpar também o URL
                    await localforage.removeItem(DB_TIMESTAMP_KEY);
                    window.location.reload(); 
                } catch(e) {
                    showToast("Erro ao limpar cache", true);
                }
            }
        }

        function triggerUpdateUpload() {
            const input = document.getElementById('fileInput');
            if(input) {
                input.value = ''; 
                input.click();
            }
        }

        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => processFile(e.target.files[0]));

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); processFile(e.dataTransfer.files[0]); });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            if(window.searchTimeout) clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                currentPage = 1;
                currentPortalFilter = null; 
                renderCards(e.target.value);
            }, 300);
        });

        document.getElementById('portalSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const items = document.querySelectorAll('#portalList button');
            items.forEach(item => {
                if(item.innerText.toLowerCase().includes(term)) item.classList.remove('hidden');
                else item.classList.add('hidden');
            });
        });

        // --- LÓGICA DE CARREGAMENTO (OTIMIZADA) ---
        async function loadFromUrl(isBackground = false) {
            const input = document.getElementById('gSheetInput');
            let rawUrl = input.value.trim();
            if (!rawUrl) { 
                if(!isBackground) showToast("Insere um link válido.", true); 
                return; 
            }
            
            // Só mostrar loading se NÃO for background
            if (!isBackground) {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('loadingTextDetail').innerText = "A tentar conectar ao Google...";
            }
            
            let fetchUrl = rawUrl;
            // Google Drive / Sheets Logic
            const driveMatch = rawUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (driveMatch && driveMatch[1]) {
                const fileId = driveMatch[1];
                if (rawUrl.includes('spreadsheets')) {
                    // FIX: Alterado para 'xlsx' e removido redirecionamentos
                    fetchUrl = `https://docs.google.com/spreadsheets/d/${fileId}/export?format=xlsx`;
                } else {
                    // FIX: Adicionado &confirm=no_antivirus para tentar bypassar aviso de virus
                    fetchUrl = `https://drive.google.com/uc?export=download&id=${fileId}&confirm=no_antivirus`;
                }
            }

            // LISTA DE PROXIES OTIMIZADA (CorsProxy.io é o mais rápido)
            const proxies = [
                (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`
            ];

            let success = false;
            let finalData = null;
            let detectedType = null;

            for (const proxyGen of proxies) {
                if (!isBackground) document.getElementById('loadingTextDetail').innerText = "A tentar servidor alternativo...";
                try {
                    const target = proxyGen(fetchUrl);
                    const controller = new AbortController();
                    // REDUZIDO TIMEOUT PARA 5s (falha rápido e tenta o próximo)
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(target, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const blob = await response.blob();
                    // Verificação de segurança: Se retornou HTML (ex: página de erro do Google ou Login)
                    if (blob.type.includes('text/html')) {
                         const text = await blob.text();
                         if(text.trim().toLowerCase().startsWith('<!doctype html') || text.includes('drive.google.com') || text.includes('accounts.google.com')) {
                             throw new Error("HTML recebido (possível bloqueio ou erro)");
                         }
                         // Se passou, talvez seja um CSV mal identificado
                         finalData = new Blob([text], {type: blob.type});
                    } else {
                        finalData = blob;
                    }

                    if (rawUrl.toLowerCase().endsWith('.json') || fetchUrl.toLowerCase().endsWith('.json')) detectedType = 'json';
                    else if (rawUrl.toLowerCase().endsWith('.csv')) detectedType = 'csv';
                    else detectedType = 'excel';
                    
                    success = true;
                    break; // Se funcionou, sai do loop
                } catch (e) { 
                    console.warn("Proxy falhou, a tentar próximo:", e); 
                }
            }

            if (success && finalData) {
                // SUCESSO! Guardar o URL para o futuro
                localforage.setItem(DB_SOURCE_URL, rawUrl);
                
                window.isBackgroundUpdate = isBackground;
                window.isUrlSource = true;
                
                if (!isBackground) document.getElementById('loadingTextDetail').innerText = "Processando ficheiro...";
                processFile(finalData, detectedType);
                input.value = '';
            } else {
                if(!isBackground) showToast("Erro ao importar. O Google pode estar a bloquear o link.", true);
                // Se falhar no background, atualiza o status para erro
                if(isBackground) document.getElementById('dataStatusMsg').innerHTML = `<i class="fa-solid fa-triangle-exclamation text-yellow-500"></i> Erro Sync`;
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        function processFile(file, forceType = null) {
            if(!file) return;
            
            // Se o utilizador carregou um ficheiro LOCAL (arrastou ou clicou),
            // devemos remover o Auto-Update do URL antigo, pois ele decidiu usar outra fonte.
            if (!window.isUrlSource) {
                 localforage.removeItem(DB_SOURCE_URL);
            }
            // Resetar a flag para a próxima
            window.isUrlSource = false;

            if (!document.getElementById('uploadSection').classList.contains('hidden')) {
                 document.getElementById('loadingIndicator').classList.remove('hidden');
            } else if (!window.isBackgroundUpdate) {
                 document.getElementById('dashLoadingOverlay').classList.remove('hidden');
            }

            let type = 'excel';
            if (forceType) type = forceType;
            else if (file.name?.toLowerCase().endsWith('.json') || file.type === 'application/json') type = 'json';
            else if (file.name?.toLowerCase().endsWith('.csv') || file.type === 'text/csv') type = 'csv';
            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                let finalType = type;
                if (finalType === 'excel') {
                    try {
                        const dec = new TextDecoder("utf-8");
                        const txt = dec.decode(content).trim();
                        if (txt.startsWith('[') || txt.startsWith('{')) finalType = 'json';
                    } catch(e) {}
                }
                worker.postMessage({ data: content, type: finalType });
            };
            reader.readAsArrayBuffer(file);
        }

        // --- LÓGICA DE UI ---
        function showDashboard() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            document.getElementById('btnBackToDash').classList.remove('hidden');
            renderCards();
        }

        function resetApp() {
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
        }

        function returnToDashboard() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        }

        function filterType(type, btn) {
            currentFilter = type;
            document.querySelectorAll('#typeFilters button').forEach(b => b.className = "whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-800 text-gray-400 hover:text-white text-sm font-medium border border-gray-700 cursor-pointer transition-all");
            btn.className = "whitespace-nowrap px-4 py-1.5 rounded-full bg-op-yellow text-dark text-sm font-bold shadow-lg shadow-op-yellow/20 transition-all";
            currentPage = 1;
            renderCards(document.getElementById('searchInput').value);
        }

        function changeItemsPerPage(val) { itemsPerPage = parseInt(val); currentPage = 1; renderCards(document.getElementById('searchInput').value); }
        function changePage(delta) { 
            currentPage += delta; 
            renderGridOnly(); 
            updatePaginationControls();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function selectPortal(host) {
            currentPortalFilter = host;
            currentPage = 1;
            renderCards(document.getElementById('searchInput').value, true);
        }

        function clearPortalFilter() {
            currentPortalFilter = null;
            renderCards(document.getElementById('searchInput').value, true);
        }

        function renderCards(term = '', keepSidebar = false) {
            term = term.toLowerCase();
            let baseFiltered = allAccounts.filter(acc => {
                if (term && !acc._search.includes(term)) return false;
                if (currentFilter === 'xtream' && acc._isMac) return false;
                if (currentFilter === 'mac' && !acc._isMac) return false;
                return true;
            });
            if (!keepSidebar) { renderSidebar(baseFiltered); }
            if (currentPortalFilter) {
                filteredAccounts = baseFiltered.filter(acc => {
                    const h = getHostName(acc.Host);
                    return h === currentPortalFilter;
                });
                document.getElementById('btnClearPortal')?.classList.remove('hidden');
            } else {
                filteredAccounts = baseFiltered;
                document.getElementById('btnClearPortal')?.classList.add('hidden');
            }
            
            const totalCountEl = document.getElementById('totalCount');
            if(totalCountEl) totalCountEl.innerText = filteredAccounts.length;
            
            document.getElementById('noResults')?.classList.toggle('hidden', filteredAccounts.length > 0);
            document.getElementById('paginationContainer')?.classList.toggle('hidden', filteredAccounts.length === 0);
            document.querySelectorAll('#portalList button').forEach(btn => {
                if (btn.dataset.host === currentPortalFilter) {
                    btn.classList.remove('bg-gray-800/50', 'text-gray-300', 'hover:bg-gray-700');
                    btn.classList.add('bg-op-yellow', 'text-dark', 'font-bold', 'shadow-md');
                } else {
                    btn.classList.add('bg-gray-800/50', 'text-gray-300', 'hover:bg-gray-700');
                    btn.classList.remove('bg-op-yellow', 'text-dark', 'font-bold', 'shadow-md');
                }
            });
            renderGridOnly();
            updatePaginationControls();
        }

        function renderSidebar(accounts) {
            const list = document.getElementById('portalList');
            const counts = {};
            accounts.forEach(acc => {
                const host = getHostName(acc.Host);
                counts[host] = (counts[host] || 0) + 1;
            });
            const sortedHosts = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            document.getElementById('portalCountBadge').innerText = sortedHosts.length;
            list.innerHTML = '';
            if (sortedHosts.length === 0) {
                list.innerHTML = '<div class="text-center py-4 text-gray-500 text-xs">Sem portais</div>';
                return;
            }
            sortedHosts.forEach(([host, count]) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-3 py-2 rounded-lg text-xs transition-all flex justify-between items-center group bg-gray-800/50 text-gray-300 hover:bg-gray-700 mb-1";
                btn.dataset.host = host;
                btn.onclick = () => selectPortal(host);
                btn.innerHTML = `<span class="truncate pr-2 font-medium" title="${host}">${host}</span><span class="bg-dark/50 text-gray-500 px-1.5 py-0.5 rounded text-[9px] group-hover:bg-dark group-hover:text-gray-300 transition-colors">${count}</span>`;
                list.appendChild(btn);
            });
        }

        function renderGridOnly() {
            const grid = document.getElementById('gridContainer');
            grid.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const itemsToShow = filteredAccounts.slice(start, start + itemsPerPage);
            itemsToShow.forEach((acc) => {
                const originalIndex = allAccounts.indexOf(acc); 
                const isMac = acc._isMac;
                const serverName = getHostName(acc.Host);
                const card = document.createElement('div');
                card.className = "bg-card rounded-xl border border-gray-700/50 hover:shadow-xl transition-all flex flex-col justify-between overflow-hidden card-animate group h-full";
                card.innerHTML = `<div class="p-5 cursor-pointer flex-grow" onclick="openModal(${originalIndex})"><div class="flex justify-between items-start mb-4"><div class="w-10 h-10 rounded-lg bg-gray-800 flex items-center justify-center border border-gray-700"><i class="fa-solid ${isMac ? 'fa-microchip text-op-yellow' : 'fa-user-circle text-blue-400'} text-lg"></i></div><span class="text-[10px] font-bold tracking-wider text-gray-500 bg-gray-900/50 px-2 py-1 rounded border border-gray-800">${isMac ? 'MAC' : 'XTREAM'}</span></div><h3 class="font-bold text-gray-100 mb-1 truncate text-base" title="${serverName}">${serverName}</h3><p class="text-xs text-gray-400 truncate font-mono">${isMac ? 'MAC: ' + (acc.MAC || 'N/A') : 'User: ' + (acc.Username || 'N/A')}</p></div><div class="bg-gray-800/50 px-5 py-3 border-t border-gray-700/50 flex justify-between items-center"><div class="text-[10px] ${acc.Validade ? 'text-green-400' : 'text-gray-500'} font-bold"><i class="fa-regular fa-calendar-check"></i> ${formatDate(acc.Validade)}</div><button onclick="openModal(${originalIndex})" class="text-op-yellow text-xs font-bold hover:underline">Detalhes</button></div>`;
                grid.appendChild(card);
            });
        }

        function updatePaginationControls() {
            const total = filteredAccounts.length;
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, total);
            const maxPage = Math.ceil(total / itemsPerPage) || 1;
            document.getElementById('pageStart').innerText = total === 0 ? 0 : start;
            document.getElementById('pageEnd').innerText = end;
            document.getElementById('pageTotal').innerText = total;
            document.getElementById('pageCurrent').innerText = currentPage;
            document.getElementById('pageMax').innerText = maxPage;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === maxPage || total === 0;
        }

        function openModal(index) {
            currentAccountIndex = index;
            const acc = allAccounts[index];
            const isMac = acc._isMac;
            const modal = document.getElementById('detailsModal');
            document.body.style.overflow = 'hidden';
            
            const hostDisplay = getHostName(acc.Host);
            document.getElementById('modalTitle').innerText = hostDisplay;
            document.getElementById('modalHost').value = acc.Host || '';
            document.getElementById('modalUser').value = acc.Username || '';
            document.getElementById('modalPass').value = acc.Password || '';
            document.getElementById('modalExp').innerText = formatDate(acc.Validade) || 'Indefinido';

            const geolockValue = (acc.Geolocked || acc.VPN || acc.Geo || '').toString().toLowerCase();
            const isGeolocked = geolockValue === 'sim' || geolockValue === 'yes' || geolockValue === 'true' || geolockValue === '1';
            const vpnBox = document.getElementById('vpnWarningBox');
            if (isGeolocked) vpnBox.classList.remove('hidden');
            else vpnBox.classList.add('hidden');

            document.getElementById('btnCheckLive').classList.remove('hidden');
            document.getElementById('liveResult').classList.add('hidden');
            const groupsContainer = document.getElementById('modalGroupsContainer');
            groupsContainer.innerHTML = '';
            
            if (isMac) {
                document.getElementById('macSection').classList.remove('hidden');
                document.getElementById('modalMac').value = acc.MAC || '';
                document.getElementById('liveCheckSection').classList.add('hidden');
                document.getElementById('m3uSection').classList.add('hidden');
                groupsContainer.innerHTML = '<span class="text-xs text-gray-500 italic p-1">Conteúdo oculto em Stalker</span>';
            } else {
                document.getElementById('macSection').classList.add('hidden');
                document.getElementById('liveCheckSection').classList.remove('hidden');
                document.getElementById('m3uSection').classList.remove('hidden');
                let h = acc.Host.startsWith('http') ? acc.Host : 'http://' + acc.Host;
                document.getElementById('modalM3u').value = `${h}/get.php?username=${acc.Username}&password=${acc.Password}&type=m3u_plus&output=ts`;
                
                const gruposStr = acc['Grupos Live'] || '';
                if (gruposStr && gruposStr !== 'Nenhum grupo encontrado') {
                    const lista = gruposStr.split(',').map(g => g.trim()).filter(g => g);
                    lista.forEach(g => {
                        const badge = document.createElement('span');
                        badge.className = "px-2 py-0.5 bg-op-yellow/10 border border-op-yellow/30 text-op-yellow text-[10px] rounded-md font-medium uppercase tracking-tight cursor-help hover:bg-op-yellow hover:text-dark transition-all";
                        badge.innerText = g;
                        badge.onclick = () => { 
                            document.getElementById('searchInput').value = g; 
                            currentPage = 1;
                            currentPortalFilter = null;
                            renderCards(g); 
                            closeModal(); 
                        };
                        groupsContainer.appendChild(badge);
                    });
                } else { groupsContainer.innerHTML = '<span class="text-xs text-gray-500 italic p-1">Grupos não catalogados</span>'; }
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById('modalContent').classList.add('scale-100'); }, 10);
        }

        async function checkLiveConnectionsInModal() {
            const btn = document.getElementById('btnCheckLive');
            const resBox = document.getElementById('liveResult');
            const resText = document.getElementById('liveResultText');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            btn.disabled = true;
            const acc = allAccounts[currentAccountIndex];
            let host = acc.Host;
            if (host && !host.startsWith('http')) { host = 'http://' + host; }
            const apiUrl = `${host}/player_api.php?username=${acc.Username}&password=${acc.Password}`;
            const proxies = [
                (url) => url,
                (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`
            ];
            let success = false;
            for (let i = 0; i < proxies.length; i++) {
                try {
                    const finalUrl = proxies[i](apiUrl);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch(finalUrl, { signal: controller.signal });
                    if (!response.ok) throw new Error(response.statusText);
                    const data = await response.json();
                    clearTimeout(timeoutId);
                    if (data.user_info) {
                        const active = data.user_info.active_cons || 0;
                        const max = data.user_info.max_connections || 0;
                        btn.classList.add('hidden');
                        resBox.classList.remove('hidden');
                        resText.innerText = `${active} / ${max}`;
                        resBox.className = `w-full bg-dark border ${active >= max && max != 0 ? 'border-red-500 text-red-400' : 'border-green-500 text-green-400'} rounded-lg px-3 py-2.5 text-xs font-bold flex items-center justify-center gap-2 h-[42px]`;
                        success = true;
                        break;
                    }
                } catch (e) {}
            }
            if (!success) {
                btn.classList.add('hidden');
                resBox.classList.remove('hidden');
                resText.innerText = "Offline / Erro";
                resBox.className = "w-full bg-dark border border-orange-500 text-orange-400 rounded-lg px-3 py-2.5 text-xs font-bold flex items-center justify-center gap-2 h-[42px]";
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Verificar Agora';
        }

        function closeModal() {
            const modal = document.getElementById('detailsModal');
            modal.classList.add('opacity-0');
            document.getElementById('modalContent').classList.remove('scale-100');
            setTimeout(() => { modal.classList.add('hidden'); document.body.style.overflow = ''; }, 300);
        }

        function openTutorialModal() {
            const modal = document.getElementById('tutorialModal');
            document.body.style.overflow = 'hidden';
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById('tutorialContent').classList.add('scale-100'); }, 10);
        }

        function closeTutorialModal() {
            const modal = document.getElementById('tutorialModal');
            modal.classList.add('opacity-0');
            document.getElementById('tutorialContent').classList.remove('scale-100');
            setTimeout(() => { modal.classList.add('hidden'); document.body.style.overflow = ''; }, 300);
        }

        function downloadPlaylistFromModal() {
            const acc = allAccounts[currentAccountIndex];
            const host = acc.Host.startsWith('http') ? acc.Host : 'http://' + acc.Host;
            const url = `${host}/get.php?username=${acc.Username}&password=${acc.Password}&type=m3u_plus&output=ts`;
            const a = document.createElement('a'); a.href = url; a.download = `playlist_${acc.Username}.m3u`; a.click();
        }

        function openPlaylistLink() { window.open(document.getElementById('modalM3u').value, '_blank'); }

        window.onclick = function(event) {
            if (event.target == document.getElementById('detailsModal')) closeModal();
            if (event.target == document.getElementById('tutorialModal')) closeTutorialModal();
        }

    </script>
</body>
</html>
